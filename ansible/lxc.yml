---

- hosts: localhost
  vars:
    container_name: test-container
  tasks:
    - name: Create a stopped container
      lxc_container:
        name: "{{ container_name }}"
        container_log: true
        template: debian
        state: stopped
        template_options: --release stretch
    - name: Start a container
      lxc_container:
        name: "{{ container_name }}"
        state: started
      register: containers_info
    - name: Wait for the network to be setup in the containers
      when: containers_info|changed
      pause: seconds=10
    - name: Get containers info now that IPs are available
      lxc_container:
        name: "{{ container_name }}"
      register: containers_info
    - name: Enable password auth for SSH
      lxc_container:
        name: "{{ container_name }}"
        container_command: "{{ item }}"
      with_items:
        - echo "root:debian" | chpasswd
        - sed -i 's/^#\?\(PermitRootLogin\) .*$/\1 yes/' /etc/ssh/sshd_config
        - systemctl restart ssh
        - apt-get -y install python
    - name: Register the hosts in the inventory
      add_host:
        name: "{{ containers_info.lxc_container.ips.0 }}"
        group: "{{ container_name }}"

- hosts: test-container
  vars:
    ansible_ssh_pass: debian
    ansible_become_method: su
  vars_files:
    - vars.yml
  tasks:
    - include: lynis.yml
    - name: Disable non-applicable tests in Lynis
      blockinfile:
        path: /etc/lynis/default.prf
        insertafter: "^# Skip a test"
        block: |
          skip-test=FILE-6310
    - name: Run Lynis
      command: /usr/sbin/lynis -Q
    - name: Get Lynis score
      command: 'sed -n "s/^.*Hardening index : \[\([0-9]\+\)\].*$/\1/p" /var/log/lynis.log'
      args:
        warn: false
      register: lynis_score_before
    - name: Lynis score before hardening
      debug:
        msg: "{{ lynis_score_before.stdout }}"
    - include: ca-certs.yml
    - include: debian_packages.yml
    - include: login_defs.yml
    - include: services.yml
    - include: sysctl.yml
    - include: sysstat.yml
    - name: Run Lynis (again)
      command: /usr/sbin/lynis -Q
    - name: Get Lynis score
      command: 'sed -n "s/^.*Hardening index : \[\([0-9]\+\)\].*$/\1/p" /var/log/lynis.log'
      args:
        warn: false
      register: lynis_score_after
    - name: Lynis score
      debug:
        msg: "before={{ lynis_score_before.stdout }} after={{ lynis_score_after.stdout }}"
    - name: Check that the file modifications worked
      shell: 'echo "{{ item.value }}  {{ item.key }}" | sha512sum -c'
      with_dict:
        /etc/login.defs: 457d44d224f3435851b92af6ebb9b191dbe8157691f36dba7145443b3b5f455158831fedb89c09fdcad41ff380394bb778f0d07c665d712354aa3f5e6690e9c6
        /etc/security/access.conf: fd2af9ee053665e242ca93f98d18923e0ec501d4f7d8bf35a808722c65d2af2d8220c0335f011b2aeccd323ea1278ec134e7a3ab2dc099a616c38dc063419008
        /etc/security/limits.conf: a5e2ab24296cff523f269f64ea73360f9135ed9dac6dd712b40138b754be37ca6c99a89b02cfff25ef5938c0adc6725039b5e62abbe350be20eb13249dfab76e
        /etc/cron.allow: cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e
